
<!doctype html>
<html lang="id">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Menarik — PETERNAKAN HEWAN</title><link rel="stylesheet" href="css/styles.css"></head>
<body>
<div class="header"><div class="inner"><div class="brand">Menarik</div><label class="toggle">☀️<input data-theme-toggle type="checkbox">🌙</label></div></div>
<div class="container">
  <div class="section grid kpi">
    <div class="box"><div class="label">Saldo Kuantitatif</div><div class="value" id="saldo">Rp 0</div></div>
    <div class="box"><div class="label">Total Aset</div><div class="value" id="asset">Rp 0</div></div>
  </div>

  <div class="section card">
    <div class="row" style="gap:12px;border-bottom:1px solid var(--line);padding-bottom:8px">
      <div class="pill">Kuota: <span id="quota">1/1</span></div>
      <div class="pill" id="pendingBanner" style="display:none">Pending</div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" data-tab="ewallet">E-Wallet</button>
      <button class="btn" data-tab="bank">Bank</button>
    </div>

    <div id="methods-ewallet" class="row mt">
      <button class="btn" data-provider="DANA">DANA</button>
      <button class="btn" data-provider="OVO">OVO</button>
      <button class="btn" data-provider="GOPAY">GoPay</button>
    </div>
    <div id="methods-bank" class="row mt" style="display:none">
      <button class="btn" data-provider="BCA">BCA</button>
      <button class="btn" data-provider="BNI">BNI</button>
      <button class="btn" data-provider="BRI">BRI</button>
      <button class="btn" data-provider="MANDIRI">Mandiri</button>
    </div>

    <div class="section" id="form" style="display:none">
      <div class="row">
        <input id="accName" class="input" placeholder="Nama pemilik">
        <input id="accNumber" class="input" placeholder="Nomor akun / rekening">
      </div>
      <div class="row">
        <input id="amount" class="input" type="number" placeholder="Nominal penarikan (min 50.000)">
      </div>
      <div class="small">Biaya admin Rp 3.000 dipotong otomatis. Yang diterima: <b id="net">Rp 0</b></div>
      <div class="row" style="justify-content:flex-end"><button id="submit" class="btn primary disabled" disabled>Ajukan</button></div>
    </div>
  </div>

  <div class="section card">
    <div style="font-weight:800;margin-bottom:8px">Riwayat</div>
    <div id="hist" class="grid"></div>
  </div>
</div>

<div class="tabbar"><div class="inner">
  <a href="dashboard.html" class="tab">🏠<div>Rumah</div></a>
  <a href="farm.html" class="tab">🐮<div>Farm</div></a>
  <a href="invite.html" class="tab">✉️<div>Mengundang</div></a>
  <a href="profile.html" class="tab">👤<div>Aku</div></a>
</div></div>

<div id="toast" class="toast"></div>
<script type="module">
import { initTheme, requireAuth, toast } from './js/app.js';
import { db } from './js/app.js';
import { collection, query, where, orderBy, onSnapshot, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

initTheme();
requireAuth();
let state = { tab:'ewallet', provider:null, pending:false, quota:1 };

window.pageReady = async ()=>{
  const me = (window.App||{}).me;
  document.getElementById('saldo').textContent = (me.saldo||0).toLocaleString('id-ID',{style:'currency',currency:'IDR'});
  // pending watcher
  const q = query(collection(db,'withdrawals'), where('userId','==', me.uid), where('status','==','pending'));
  onSnapshot(q,(snap)=>{
    state.pending = !snap.empty;
    document.getElementById('pendingBanner').style.display = state.pending ? '' : 'none';
    document.getElementById('quota').textContent = state.pending ? '0/1' : '1/1';
    validate();
  });
  // history
  const qh = query(collection(db,'withdrawals'), where('userId','==', me.uid), orderBy('createdAt','desc'));
  onSnapshot(qh,(snap)=>{
    const hist = document.getElementById('hist'); hist.innerHTML='';
    snap.forEach(d=>{
      const w = d.data();
      const el = document.createElement('div'); el.className='card';
      el.innerHTML = `<div class="row" style="justify-content:space-between">
        <div>${w.provider}</div><div>${(w.amount||0).toLocaleString('id-ID',{style:'currency',currency:'IDR'})}</div>
        <div>${(w.amountNet||0).toLocaleString('id-ID',{style:'currency',currency:'IDR'})}</div>
        <div>${w.status}</div></div>`;
      hist.appendChild(el);
    });
  });
};

// tab switching
document.querySelectorAll('[data-tab]').forEach(b=> b.addEventListener('click', ()=>{
  state.tab = b.getAttribute('data-tab');
  document.getElementById('methods-ewallet').style.display = state.tab==='ewallet' ? '' : 'none';
  document.getElementById('methods-bank').style.display = state.tab==='bank' ? '' : 'none';
  state.provider=null; document.getElementById('form').style.display='none';
}));

document.querySelectorAll('#methods-ewallet .btn, #methods-bank .btn').forEach(b=> b.addEventListener('click', ()=>{
  state.provider = b.getAttribute('data-provider');
  document.getElementById('form').style.display='';
  validate();
}));

['accName','accNumber','amount'].forEach(id=> document.getElementById(id).addEventListener('input', validate));

function validate(){
  const name = accName.value.trim(), no = accNumber.value.trim();
  const amt = parseInt(amount.value,10)||0;
  const net = Math.max(0, amt - 3000);
  document.getElementById('net').textContent = net.toLocaleString('id-ID',{style:'currency',currency:'IDR'});
  const ok = state.provider && name && no && amt>=50000 && !state.pending;
  document.getElementById('submit').disabled = !ok;
  document.getElementById('submit').classList.toggle('disabled', !ok);
}

document.getElementById('submit').addEventListener('click', async ()=>{
  const me = (window.App||{}).me;
  const amt = parseInt(amount.value,10)||0;
  const net = Math.max(0, amt-3000);
  await addDoc(collection(db,'withdrawals'), {
    userId: me.uid, method: state.tab, provider: state.provider, accountName: accName.value.trim(),
    accountNumber: accNumber.value.trim(), amount: amt, fee: 3000, amountNet: net, status:'pending', createdAt: serverTimestamp()
  });
  toast('Pengajuan berhasil. Tunggu hingga 15 menit.');
});
</script>
</body>
</html>
