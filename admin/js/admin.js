import{requireAdmin}from"../../shared/auth.js";import{db,doc,getDoc,updateDoc,collection,onSnapshot,query,orderBy,limit,serverTimestamp,addDoc,runTransaction}from"../../shared/firebase.js";const ctx=await requireAdmin();if(!ctx)throw new Error("forbidden");document.querySelectorAll(".menu button").forEach(n=>n.addEventListener("click",()=>{document.querySelectorAll(".menu button").forEach(e=>e.classList.remove("active")),n.classList.add("active"),document.querySelectorAll(".section").forEach(e=>e.classList.remove("active")),document.getElementById(n.dataset.tab).classList.add("active")}));const ot=document.querySelector("#ordersTable tbody");onSnapshot(query(collection(db,"orders"),orderBy("createdAt","desc"),limit(200)),s=>{ot.innerHTML="",s.forEach(d=>{const o=d.data(),t=document.createElement("tr"),r=o.proofUrl?`<a href="${o.proofUrl}" target="_blank">Lihat</a>`:"â€”";t.innerHTML=`<td>${(o.createdAt?.toDate?.()||new Date).toLocaleString("id-ID")}</td><td>${o.uid||"-"}</td><td>${o.product||"-"}</td><td>Rp${(o.price||0).toLocaleString("id-ID")}</td><td>${r}</td><td><span class="badge">${o.status}</span></td><td><button class="btn ok" data-act="approve" data-id="${d.id}">Approve</button> <button class="btn" data-act="reject" data-id="${d.id}">Reject</button></td>`,ot.appendChild(t)})});ot.addEventListener("click",async e=>{const n=e.target.closest("button");if(!n)return;const t=n.dataset.id,a=n.dataset.act,c=doc(db,"orders",t),o=await getDoc(c);if(!o.exists())return;const r=o.data();if("approve"===a)await runTransaction(db,async s=>{s.update(c,{status:"approved"});const e=new Date;await addDoc(collection(db,"holdings"),{uid:r.uid,animalId:r.animalId,product:r.product,startAt:serverTimestamp(),endAt:new Date(e.getTime()+(r.cycleDays||2592e6)),locked:!0})});else"reject"===a&&await updateDoc(c,{status:"rejected"})});const wt=document.querySelector("#wdTable tbody");onSnapshot(query(collection(db,"withdrawals"),orderBy("createdAt","desc"),limit(200)),s=>{wt.innerHTML="",s.forEach(d=>{const w=d.data(),t=document.createElement("tr"),n=(w.amount||0)-(w.fee||0);t.innerHTML=`<td>${(w.createdAt?.toDate?.()||new Date).toLocaleString("id-ID")}</td><td>${w.uid||"-"}</td><td>${w.method||"-"}</td><td>${w.account||"-"}</td><td>Rp${(w.amount||0).toLocaleString("id-ID")}</td><td>Rp${(w.fee||0).toLocaleString("id-ID")}</td><td>Rp${n.toLocaleString("id-ID")}</td><td><span class="badge">${w.status}</span></td><td><button class="btn ok" data-act="apw" data-id="${d.id}">Approve</button> <button class="btn" data-act="rjw" data-id="${d.id}">Reject</button></td>`,wt.appendChild(t)})});wt.addEventListener("click",async e=>{const n=e.target.closest("button");if(!n)return;const t=n.dataset.id,a=n.dataset.act,c=doc(db,"withdrawals",t),o=await getDoc(c);if(!o.exists())return;"apw"===a?await updateDoc(c,{status:"approved"}):"rjw"===a&&await updateDoc(c,{status:"rejected"})});const sMin=document.getElementById("sMin"),sFee=document.getElementById("sFee"),sLimit=document.getElementById("sLimit"),mStatus=document.getElementById("mStatus"),mMsg=document.getElementById("mMsg");async function loadS(){const e=await getDoc(doc(db,"app_settings","settings"));e.exists()&&(sMin.value=e.data().minWithdraw||5e4,sFee.value=e.data().fee||3e3,sLimit.value=e.data().limitDaily||1);const n=await getDoc(doc(db,"app_settings","maintenance"));n.exists()&&(mStatus.value=n.data().status||"OFF",mMsg.value=n.data().message||"")}loadS();document.getElementById("saveWD").addEventListener("click",async()=>{await updateDoc(doc(db,"app_settings","settings"),{minWithdraw:Number(sMin.value||5e4),fee:Number(sFee.value||3e3),limitDaily:Number(sLimit.value||1),updatedAt:serverTimestamp()}),alert("Settings penarikan disimpan.")});document.getElementById("saveM").addEventListener("click",async()=>{await updateDoc(doc(db,"app_settings","maintenance"),{status:mStatus.value,message:mMsg.value||"",updatedAt:serverTimestamp()}),alert("Maintenance disimpan.")});