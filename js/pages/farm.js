import{boot,toast}from"../app.js";import{requireLogin}from"../../shared/auth.js";import{auth,db,collection,onSnapshot,addDoc,serverTimestamp,doc,getDoc,updateDoc}from"../../shared/firebase.js";import{cloudinary}from"../config.js";boot();await requireLogin();const wrap=document.getElementById("animals");onSnapshot(collection(db,"animals"),s=>{wrap.innerHTML="",s.forEach(o=>{const t=o.data(),e=document.createElement("div");e.className="tile",e.innerHTML=`<div class="icon">${t.emoji||"üêÆ"}</div><div class="label">${t.name||o.id}</div><div style="font-size:12px;color:#9fb3c8">Rp${(t.price||0).toLocaleString("id-ID")} ‚Ä¢ ${t.cycleDays||0} hari</div><button class="btn ok" data-id="${o.id}" style="margin-top:8px">Beli</button>`,wrap.appendChild(e)}),wrap.querySelectorAll("button").forEach(o=>o.addEventListener("click",t=>buy(t.target.dataset.id)))});async function buy(s){const o=auth.currentUser.uid,t=await getDoc(doc(db,"animals",s));if(!t.exists())return alert("Produk tidak ditemukan");const e=t.data(),a=await addDoc(collection(db,"orders"),{uid:o,product:e.name,animalId:s,price:e.price||0,status:"pending",createdAt:serverTimestamp()}),n=document.createElement("input");n.type="file",n.accept="image/*",n.onchange=async()=>{const d=n.files[0];if(!d)return;const i=new FormData;i.append("upload_preset",cloudinary.uploadPreset),i.append("file",d);const c=await fetch(`https://api.cloudinary.com/v1_1/${cloudinary.cloudName}/auto/upload`,{method:"POST",body:i}),l=await c.json();l.secure_url?(await updateDoc(doc(db,"orders",a.id),{proofUrl:l.secure_url}),toast("Bukti terkirim. Menunggu approve admin.")):alert("Gagal upload bukti.")},n.click()}