import{boot,toast}from"../app.js";import{requireLogin}from"../../shared/auth.js";import{auth,db,collection,onSnapshot,addDoc,serverTimestamp,doc,getDoc,updateDoc}from"../../shared/firebase.js";import{cloudinary}from"../config.js";boot();await requireLogin();const w=document.getElementById("animals");onSnapshot(collection(db,"animals"),s=>{w.innerHTML="",s.forEach(o=>{const t=o.data(),e=document.createElement("div");e.className="tile",e.innerHTML=`<div class="icon">${t.emoji||"üêÆ"}</div><div class="label">${t.name||o.id}</div><div style="font-size:12px;color:#9fb3c8">Rp${(t.price||0).toLocaleString("id-ID")} ‚Ä¢ ${t.cycleDays||0} hari</div><button class="btn ok" data-id="${o.id}" style="margin-top:8px">Beli</button>`,w.appendChild(e)}),w.querySelectorAll("button").forEach(e=>e.addEventListener("click",e=>buy(e.target.dataset.id)))});async function buy(n){const e=auth.currentUser.uid,s=await getDoc(doc(db,"animals",n));if(!s.exists())return alert("Produk tidak ditemukan");const a=s.data(),r=await addDoc(collection(db,"orders"),{uid:e,product:a.name,animalId:n,price:a.price||0,cycleDays:a.cycleDays||2592000000,status:"pending",createdAt:serverTimestamp()});const i=document.createElement("input");i.type="file",i.accept="image/*",i.onchange=async()=>{const d=i.files[0];if(!d)return;const c=new FormData;c.append("upload_preset",cloudinary.uploadPreset),c.append("file",d);const l=await fetch(`https://api.cloudinary.com/v1_1/${cloudinary.cloudName}/auto/upload`,{method:"POST",body:c}),u=await l.json();u.secure_url?(await updateDoc(doc(db,"orders",r.id),{proofUrl:u.secure_url}),toast("Bukti terkirim. Menunggu approve admin.")):alert("Gagal upload bukti.")},i.click()}