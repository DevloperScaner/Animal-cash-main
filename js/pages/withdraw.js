import{boot}from"../app.js";import{requireLogin}from"../../shared/auth.js";import{auth,db,collection,addDoc,query,where,orderBy,limit,getDocs,serverTimestamp,doc,getDoc}from"../../shared/firebase.js";boot();await requireLogin();async function getSettings(){const e=await getDoc(doc(db,"app_settings","settings"));return e.exists()?e.data():{minWithdraw:50000,fee:3000,limitDaily:1}}async function canWithdraw(e){const t=query(collection(db,"withdrawals"),where("uid","==",e),where("status","in",["pending","approved"]),orderBy("createdAt","desc"),limit(1)),a=await getDocs(t);if(a.empty)return!0;const r=a.docs[0].data(),o=r.createdAt?.toDate?.()||new Date,n=new Date;return!(o.toDateString()===n.toDateString()&&r.status!=="rejected")}document.getElementById("submit").addEventListener("click",async()=>{const e=auth.currentUser.uid,t=document.getElementById("method").value,a=document.getElementById("account").value.trim(),r=Number(document.getElementById("amount").value||0),o=await getSettings();if(r<(o.minWithdraw||50000))return alert(`Minimal penarikan Rp ${(o.minWithdraw||50000).toLocaleString("id-ID")}`);if(!await canWithdraw(e))return alert("Tunggu approve admin dulu (limit 1x/hari).");await addDoc(collection(db,"withdrawals"),{uid:e,method:t,account:a,amount:r,fee:o.fee||3000,status:"pending",createdAt:serverTimestamp()}),alert("Pengajuan terkirim. Noted: tunggu hingga 15 menit, jika belum masuk hubungi admin di Contact.")});