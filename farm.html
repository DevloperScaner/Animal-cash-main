
<!doctype html>
<html lang="id">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Farm — PETERNAKAN HEWAN</title><link rel="stylesheet" href="css/styles.css"></head>
<body>
<div class="header"><div class="inner"><div class="brand">Farm</div><div class="actions"><label class="toggle">☀️<input data-theme-toggle type="checkbox">🌙</label></div></div></div>
<div class="container">
  <div class="section card">
    <div class="grid kpi">
      <div class="box"><div class="label">Total Aset</div><div class="value" id="kAsset">Rp 0</div></div>
      <div class="box"><div class="label">Akun Kuantitatif</div><div class="value" id="kSaldo">Rp 0</div></div>
    </div>
    <div class="section">
      <div id="list" class="grid" style="grid-template-columns:1fr;gap:12px"></div>
    </div>
  </div>
</div>
<div class="tabbar"><div class="inner">
  <a href="dashboard.html" class="tab">🏠<div>Rumah</div></a>
  <a href="farm.html" class="tab active">🐮<div>Farm</div></a>
  <a href="invite.html" class="tab">✉️<div>Mengundang</div></a>
  <a href="profile.html" class="tab">👤<div>Aku</div></a>
</div></div>
<div id="toast" class="toast"></div>

<input type="file" id="proof" accept="image/*" style="display:none"/>
<script type="module">
import { initTheme, requireAuth, toast, uploadProof } from './js/app.js';
import { db } from './js/app.js';
import { collection, getDocs, query, where, addDoc, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

initTheme();
requireAuth();
window.pageReady = async ()=>{
  const me = (window.App||{}).me;
  document.getElementById('kSaldo').textContent = (me.saldo||0).toLocaleString('id-ID',{style:'currency',currency:'IDR'});

  const list = document.getElementById('list');
  const snap = await getDocs(query(collection(db,'farmProducts'), where('active','==', true)));
  list.innerHTML='';
  snap.forEach(d=>{
    const p = d.data();
    const el = document.createElement('div');
    el.className='card';
    el.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800">${p.name}</div>
          <div class="row small" style="margin-top:6px;color:var(--muted)">
            <span>Harga ${format(p.price)}</span><span>•</span>
            <span>Harian ${format(p.dailyIncome)}</span><span>•</span>
            <span>Siklus ${p.cycleDays} hari</span>
          </div>
        </div>
        <button class="btn good" data-buy="${d.id}">Beli</button>
      </div>
    `;
    list.appendChild(el);
  });

  function format(n){ return n?.toLocaleString('id-ID',{style:'currency',currency:'IDR'}) || 'Rp 0'; }

  document.querySelectorAll('[data-buy]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const pid = btn.getAttribute('data-buy');
      // upload bukti (scan QR)
      const file = await pickFile();
      if(!file) return toast('Bukti diperlukan');
      const url = await uploadProof(file);
      // get product snapshot
      const ps = await getDoc(doc(db,'farmProducts', pid));
      const prod = ps.data();
      // create order pending
      await addDoc(collection(db,'orders'), {
        userId: me.uid, productId: pid, productName: prod.name,
        price: prod.price, dailyIncome: prod.dailyIncome, cycleDays: prod.cycleDays,
        proofUrl: url, status:'pending', locked:false, createdAt: serverTimestamp()
      });
      toast('Order terkirim. Menunggu approve admin.');
    });
  });

  function pickFile(){
    return new Promise(res=>{
      const input = document.getElementById('proof');
      input.onchange = ()=> res(input.files[0]||null);
      input.click();
    });
  }
};
</script>
</body>
</html>
